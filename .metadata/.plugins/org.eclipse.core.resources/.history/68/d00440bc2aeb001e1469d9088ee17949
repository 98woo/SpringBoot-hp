package com.hello.forum.member.web;

import java.util.HashMap;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import com.hello.forum.member.service.MemberService;
import com.hello.forum.member.vo.MemberVO;



@Controller
public class MemberController {

	@Autowired
	private MemberService memberService;
	
	@GetMapping("/member/regist")
	public String viewRegistMemberPage(Model model) {
		
		System.out.println("member member member");
		return "member/memberregist";
	}
	
	// http://localhost:8080/member/regist/available?email=aaa@aaa.com
	@ResponseBody // 응답하는 데이터를 JSON으로 변환해 클라이언트에게 반환한다.
	@GetMapping("/member/regist/available")
	public Map<String, Object> checkAvailableEmail(@RequestParam String email) {
		
		// 사용 가능한 이메일이라면 true
		// 아니라면 false
		boolean isAvailableEmail = this.memberService.checkAvailableEmail(email);
		
		/*
		 * ResponseBody 어노테이션을 사용 했을 때 Map 을 반환시키면 key value 를 이용해서 아래와 같은 객체 리터럴을 반환한다. 
		 * Spring 이 바꿔준다.
		 * {
		 * 	"email": "aaa@aaa.com",
		 *  "availalbe": false
		 *  }
		 */
		Map<String, Object> responseMap = new HashMap<>();
		responseMap.put("email", email);
		responseMap.put("available", isAvailableEmail);
		
		return responseMap;
	}
	
	@PostMapping("/member/regist")
	public String doRegistMember(MemberVO memberVO, Model model, BindingResult bindingResult) {
		
		
		if (bindingResult.hasErrors()) {
			
			model.addAttribute("memberVO", memberVO);
			return "member/memberregist";
			
		}
		
		boolean isSuccess = this.memberService.createNewMember(memberVO);
		
		if (isSuccess) {
			
			return "redirect:/member/login";
		}
		
		model.addAttribute("memberVO", memberVO);
		return "member/memberregist";
	}
	
//	@ResponseBody // JSON 으로 응답한다.
//	@GetMapping("/member/regist/available")
//	public Map<String, Object> checkAvailalbeEmail(@RequestParam String email) {
//		
//		boolean isAvailableEmail = memberService.checkAvailableEmail(email);
//		
//		Map<String, Object> responseMap = memberService.checkAvailableEmail(email);
//		// Map을 Return 하면 @ResponseBody 에 의해 JSON 으로 변환되어 응답된다.
//		return responseMap;
//	}
}
